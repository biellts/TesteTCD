<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">

<ui:composition template="/templates/layout.xhtml">
    <ui:define name="conteudo">
        <div class="container" style="max-width: 950px; margin: 40px auto;">
            <h1 class="text-center mb-4" style="color: var(--primary);">
                Buscar Agendamento
            </h1>

            <!-- Formulário de busca -->
            <h:form id="formBusca">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label class="col-form-label fw-bold">CPF ou Protocolo:</label>
                            </div>
                            <div class="col-md-6">
                                <p:inputText value="#{buscaAgendamentoController.busca}"
                                             placeholder="Ex: 12345678900 ou ABC123"
                                             styleClass="form-control form-control-lg"
                                             maxlength="20"/>
                            </div>
                            <div class="col-auto">
                                <p:commandButton value="Buscar"
                                                 action="#{buscaAgendamentoController.buscar}"
                                                 update="formBusca resultado mensagens"
                                                 process="@this busca"
                                                 styleClass="btn btn-primary btn-lg px-5"
                                                 icon="pi pi-search"/>
                            </div>
                        </div>
                    </div>
                </div>
            </h:form>

            <!-- Mensagens globais -->
            <h:messages id="mensagens" globalOnly="true" styleClass="mt-3" />

            <!-- Resultado da busca -->
            <h:panelGroup id="resultado">
                <h:form rendered="#{buscaAgendamentoController.agendamento != null}">
                    <div class="card mt-4 shadow">
                        <div class="card-header text-white" style="background: var(--primary);">
                            <h4 class="mb-0">
                                Agendamento: #{buscaAgendamentoController.agendamento.protocolo}
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Cliente:</strong> #{buscaAgendamentoController.agendamento.usuario.nome}</p>
                                    <p class="mb-2"><strong>CPF:</strong> #{buscaAgendamentoController.agendamento.usuario.cpf}</p>
                                    <p class="mb-2"><strong>Serviço:</strong> #{buscaAgendamentoController.agendamento.servico.nome}</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Data/Hora:</strong> #{buscaAgendamentoController.dataHoraFormatada}</p>
                                    <p class="mb-2"><strong>Status:</strong>
                                        <span class="badge fw-bold"
                                              style="background-color: #{buscaAgendamentoController.agendamento.status.cor};
                                                     color: #212529;
                                                     padding: 10px 16px;
                                                     font-size: 1em;">
                                            #{buscaAgendamentoController.agendamento.status.descricao}
                                        </span>
                                    </p>
                                </div>
                            </div>

                            <hr class="my-4"/>

                            <div class="d-flex flex-wrap gap-3">
                                <!-- Imprimir comprovante -->
                                <p:commandButton value="Imprimir Comprovante"
                                                 ajax="false"
                                                 icon="pi pi-print"
                                                 styleClass="btn btn-success btn-lg"/>

                                <!-- Cancelar (só se permitido) -->
                                <p:commandButton value="Cancelar Agendamento"
                                                 rendered="#{buscaAgendamentoController.podeCancelar}"
                                                 action="#{buscaAgendamentoController.cancelar}"
                                                 update="resultado mensagens"
                                                 onclick="return confirm('Tem certeza que deseja cancelar este agendamento?');"
                                                 styleClass="btn btn-danger btn-lg"/>

                                <!-- Check-in (só recepcionista e se AGENDADO) -->
                                <p:commandButton value="Fazer Check-in"
                                                 rendered="#{buscaAgendamentoController.isRecepcao 
                                                           and buscaAgendamentoController.agendamento.status == 'AGENDADO'}"
                                                 action="#{buscaAgendamentoController.checkIn}"
                                                 update="resultado mensagens"
                                                 styleClass="btn btn-warning btn-lg text-dark"/>
                            </div>
                        </div>
                    </div>
                </h:form>
            </h:panelGroup>
        </div>
    </ui:define>
</ui:composition>
</html>