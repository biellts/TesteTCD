<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">

<ui:composition template="/templates/layout.xhtml">

    <ui:define name="conteudo">
        <div style="max-width:800px; margin:40px auto; padding:20px;">

            <h1 style="color:var(--primary); text-align:center; margin-bottom:30px; font-size:2.2em;">
                Reagendar Atendimento
            </h1>

            <h:messages globalOnly="true" style="margin-bottom:20px;" />

            <h:form id="formReagendamento">

                <!-- 0. Agendamento Selecionado -->
                <h:panelGroup rendered="#{not empty agendamentoSimplificadoController.agendamentoSelecionado}">
                    <h:outputText value="Protocolo: #{agendamentoSimplificadoController.agendamentoSelecionado.protocolo}" 
                                  style="display:block;font-weight:bold;margin-bottom:10px;" />
                    <h:outputText value="Serviço: #{agendamentoSimplificadoController.agendamentoSelecionado.servico.nome}" 
                                  style="display:block;margin-bottom:20px;" />
                </h:panelGroup>

                <h:panelGroup rendered="#{empty agendamentoSimplificadoController.agendamentoSelecionado}">
                    <h:outputText value="Agendamento não encontrado." style="color:#d32f2f;font-weight:bold;" />
                </h:panelGroup>

                <!-- 1. Seleção da nova data -->
                <div class="card" style="padding:20px; border-radius:12px; margin-bottom:16px; border:1px solid #ddd;">
                    <h3 style="margin-top:0;">1. Escolha a nova data *</h3>
                    <h:panelGroup rendered="#{not empty agendamentoSimplificadoController.diasDisponiveis}">
                        <p:selectOneMenu id="novaData" value="#{agendamentoSimplificadoController.novaData}" converter="localDateConverter" style="width:100%;">
                            <f:selectItem itemLabel="Selecione..." itemValue="#{null}" />
                            <f:selectItems value="#{agendamentoSimplificadoController.diasDisponiveis}" var="d"
                                           itemLabel="#{agendamentoSimplificadoController.formatarData(d)}" itemValue="#{d}" />
                            <!-- Atualiza somente os componentes dentro do mesmo form -->
                            <p:ajax listener="#{agendamentoSimplificadoController.aoSelecionarNovaData}" 
                                    update="novoHorario resumoReagendamento" 
                                    process="@this" />
                        </p:selectOneMenu>
                    </h:panelGroup>
                    <h:outputText value="Não há datas disponíveis." rendered="#{empty agendamentoSimplificadoController.diasDisponiveis}" 
                                  style="color:#d32f2f; font-weight:bold; display:block;" />
                </div>

                <!-- 2. Seleção do novo horário -->
                <div class="card" style="padding:20px; border-radius:12px; margin-bottom:16px; border:1px solid #ddd;">
                    <h3 style="margin-top:0;">2. Escolha o novo horário *</h3>
                    <h:panelGroup rendered="#{not empty agendamentoSimplificadoController.horariosParaReagendamento}">
                        <p:selectOneMenu id="novoHorario" value="#{agendamentoSimplificadoController.novoHorarioId}" style="width:100%;">
                            <f:selectItem itemLabel="Selecione..." itemValue="#{null}" />
                            <f:selectItems value="#{agendamentoSimplificadoController.horariosParaReagendamento}" var="h"
                                           itemLabel="#{agendamentoSimplificadoController.formatarHora(h)}" itemValue="#{h.id}" />
                            <p:ajax update="resumoReagendamento" process="@this"/>
                        </p:selectOneMenu>
                    </h:panelGroup>
                    <h:outputText value="Selecione uma data primeiro para ver os horários disponíveis." 
                                  rendered="#{empty agendamentoSimplificadoController.horariosParaReagendamento}" 
                                  style="color:#d32f2f; font-weight:bold; display:block;" />
                </div>

                <!-- 3. Resumo do reagendamento -->
                <h:panelGroup id="resumoReagendamento" layout="block" style="padding:20px; border-radius:12px; margin-bottom:16px; border:1px solid #ddd; background:#f9f9f9;">
                    <h3 style="margin-top:0;">Resumo do Reagendamento</h3>
                    <p><strong>Serviço:</strong> #{agendamentoSimplificadoController.nomeServicoSelecionado}</p>
                    <p><strong>Data:</strong> #{agendamentoSimplificadoController.novaData != null ? agendamentoSimplificadoController.formatarData(agendamentoSimplificadoController.novaData) : '-'}</p>
                    <p><strong>Horário:</strong> #{agendamentoSimplificadoController.getHorarioSelecionadoParaReagendamento()}</p>
                </h:panelGroup>

                <!-- 4. Botão Confirmar Reagendamento -->
                <div class="card" style="padding:16px; border-radius:12px; border:1px solid #ddd;">
                    <h:commandButton id="btnConfirmar" value="Confirmar Reagendamento"
                                     action="#{agendamentoSimplificadoController.confirmarReagendamento(agendamentoSimplificadoController.agendamentoSelecionado)}"
                                     style="width:100%; padding:14px; font-size:1.2em; background-color:#28a745; color:white; border:none; border-radius:6px; cursor:pointer;"
                                     rendered="#{agendamentoSimplificadoController.novaData != null and agendamentoSimplificadoController.novoHorarioId != null}"
                                     onclick="return confirm('Deseja confirmar este reagendamento?');" />
                    <h:outputText value="Selecione data e horário para continuar."
                                  rendered="#{agendamentoSimplificadoController.novaData == null or agendamentoSimplificadoController.novoHorarioId == null}"
                                  style="display:block; text-align:center; color:#999; font-style:italic; padding:14px;" />
                </div>

            </h:form>
        </div>
    </ui:define>
</ui:composition>
</html>
